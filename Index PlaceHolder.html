<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MSI Propales B2 ¬∑ Neural Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ... COPIER LE CSS DE B1 (NEURAL DESIGN) ... */
    /* ... JE REMETS LE CSS ESSENTIEL POUR LA DEMO ... */
    :root { --bg: #050505; --glass-bg: rgba(255,255,255,0.06); --primary: #00ffff; --secondary: #ff69b4; --text: #f2e7ff; }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; padding: 40px 20px; overflow-x: hidden; }
    .neural-background { position: fixed; inset: 0; z-index: -3; background: radial-gradient(circle at 15% 85%, rgba(75,0,130,0.7), transparent 55%), linear-gradient(135deg, #050505, #12051c); }
    .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 40px; grid-template-columns: 1.7fr 1fr; }
    .glass-panel { background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 28px; padding: 30px; margin-bottom: 25px; backdrop-filter: blur(20px); }
    h2 { font-size: 1.2rem; color: #fff; margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .full { grid-column: 1 / -1; }
    label { display: block; font-size: 0.75rem; text-transform: uppercase; color: rgba(255,255,255,0.6); margin-bottom: 6px; letter-spacing: 1px; }
    input, textarea { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 14px; border-radius: 12px; font-family: inherit; transition: 0.3s; }
    input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 15px rgba(0,255,255,0.1); }
    .ph-tag { color: var(--secondary); font-family: monospace; font-size: 0.8em; float: right; }
    button#btnGenerate { width: 100%; padding: 18px; background: linear-gradient(135deg, #e0a3ff, var(--primary)); border: none; border-radius: 50px; color: #000; font-weight: 700; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: transform 0.2s; }
    button#btnGenerate:hover { transform: scale(1.02); box-shadow: 0 0 30px rgba(0,255,255,0.4); }
    
    /* Styles sp√©cifiques B1 (Console, Progress) */
    .insights-panel { position: sticky; top: 20px; }
    .result-status { padding: 20px; border-radius: 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .progress-bar { height: 6px; background: #333; border-radius: 10px; margin-top: 10px; overflow: hidden; }
    .progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s; }
    
    @media(max-width: 900px) { .container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="neural-background"></div>

  <div class="container">
    
    <div class="form-panels">
      
      <div class="glass-panel">
        <h2>1. Identit√© Projet (B2 Core)</h2>
        <div class="form-grid">
          <div class="full">
            <label>Titre de la proposition <span class="ph-tag">{{titre}}</span></label>
            <input type="text" id="f_titre" placeholder="Transformation Lean et D√©m√©nagement..." required>
          </div>
          <div>
            <label>Entreprise <span class="ph-tag">{{entrepriseNom}}</span></label>
            <input type="text" id="f_entrepriseNom" placeholder="Les Ateliers Autrement">
          </div>
          <div>
            <label>Code Projet <span class="ph-tag">{{codeProjet}}</span></label>
            <input type="text" id="f_codeProjet" placeholder="Auto si vide">
          </div>
          <div>
            <label>Date <span class="ph-tag">{{dateDebut}}</span></label>
            <input type="text" id="f_dateDebut" placeholder="F√©vrier 2026">
          </div>
          <div>
            <label>Dur√©e Texte <span class="ph-tag">{{dureeProjet}}</span></label>
            <input type="text" id="f_dureeProjet" placeholder="2 ans">
          </div>
          <div><label>Nb √âquipes</label><input type="number" id="f_nbEquipes" value="2"></div>
          <div><label>Semaines Total</label><input type="number" id="f_dureeSemaines" value="96"></div>
          <div class="full">
            <label>Logo URL <span class="ph-tag">{{entrepriseLogo}}</span></label>
            <input type="text" id="f_entrepriseLogo" placeholder="http... (ou laisser vide pour Icam)">
          </div>
        </div>
      </div>

      <div class="glass-panel">
        <h2>2. Intelligence Artificielle & Documents</h2>
        <div class="form-grid">
          <div class="full">
            <label>Histoire & ADN Client <span class="ph-tag" style="color:#aaa">Context B2</span></label>
            <textarea id="f_ia_histoire" rows="2" placeholder="Ex: Cr√©√©e en 1970, savoir-faire artisanal, famille..."></textarea>
          </div>
          <div class="full">
            <label>Lieux / G√©ographie <span class="ph-tag" style="color:#aaa">Context B2</span></label>
            <input type="text" id="f_ia_lieux" placeholder="Ex: D√©m√©nagement de Brie-Comte-Robert √† Moissy">
          </div>
          
          <div class="full">
            <label>Pi√®ces Jointes (PDF/Images pour OCR) <span style="color:var(--primary)">Neural Feature</span></label>
            <input type="file" id="f_attachments" multiple style="padding:10px;">
            <div id="fileList" style="font-size:0.8rem; margin-top:5px; color:var(--primary)"></div>
          </div>

          <div class="full"><label>Probl√®me</label><textarea id="f_ia_probleme" rows="2"></textarea></div>
          <div class="full"><label>Solution</label><textarea id="f_ia_solution" rows="2"></textarea></div>
          <div class="full"><label>Objectifs</label><textarea id="f_ia_objectifs" rows="2"></textarea></div>
        </div>
        
        <div style="margin-top:30px;">
          <button id="btnGenerate">‚ö° LANCER NEURAL ENGINE B2</button>
        </div>
      </div>
    </div>

    <aside>
      <div class="insights-panel">
        <div class="result-status">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <strong>STATUT LIVE</strong>
            <span id="tokenEstimate" style="font-size:0.8rem; color:#aaa">0 tokens</span>
          </div>
          <div id="statusText">Syst√®me pr√™t.</div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>

        <div class="glass-panel" style="padding:20px;">
          <h4 style="margin:0 0 15px 0; color:#fff;">JOURNAL DE BORD</h4>
          <ul id="consoleLog" style="list-style:none; padding:0; font-size:0.8rem; color:#aaa; max-height:200px; overflow-y:auto;">
            <li>> Initialisation Matrix B2...</li>
          </ul>
        </div>

        <div id="resultLinks" style="display:none; text-align:center;">
          <a href="#" id="docLink" target="_blank" style="display:block; padding:12px; background:rgba(255,255,255,0.1); color:#fff; text-decoration:none; border-radius:10px; margin-bottom:10px;">üìÑ Ouvrir GDoc</a>
          <a href="#" id="pdfLink" target="_blank" style="display:block; padding:12px; background:var(--primary); color:#000; text-decoration:none; border-radius:10px; font-weight:bold;">‚¨áÔ∏è PDF Final</a>
        </div>
      </div>
    </aside>

  </div>

  <script>
    const logList = document.getElementById('consoleLog');
    function log(msg) {
      const li = document.createElement('li');
      li.textContent = `> ${msg}`;
      logList.prepend(li);
    }

    // Gestion Fichiers (Base64)
    const fileInput = document.getElementById('f_attachments');
    let selectedFiles = [];
    
    fileInput.addEventListener('change', (e) => {
      selectedFiles = Array.from(e.target.files);
      document.getElementById('fileList').textContent = `${selectedFiles.length} fichier(s) pr√™t(s) pour OCR.`;
    });

    const readFile = (file) => new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve({ name: file.name, mimeType: file.type, bytes: reader.result.split(',')[1] });
      reader.readAsDataURL(file);
    });

    // Action G√©n√©rer
    document.getElementById('btnGenerate').addEventListener('click', async () => {
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      document.getElementById('progressFill').style.width = '10%';
      document.getElementById('statusText').textContent = 'Pr√©paration des donn√©es...';
      
      const data = {};
      // Collecte des IDs B2
      ['titre', 'entrepriseNom', 'codeProjet', 'dateDebut', 'dureeProjet', 'nbEquipes', 'dureeSemaines', 'entrepriseLogo', 
       'ia_histoire', 'ia_lieux', 'ia_probleme', 'ia_solution', 'ia_objectifs'].forEach(id => {
        data[id] = document.getElementById('f_' + id).value;
      });

      if(!data.titre || !data.entrepriseNom) {
        alert("Champs requis manquants");
        btn.disabled = false;
        return;
      }

      // Lecture fichiers
      if (selectedFiles.length) {
        log("Encodage fichiers...");
        data.attachments = await Promise.all(selectedFiles.map(readFile));
      }

      document.getElementById('progressFill').style.width = '40%';
      document.getElementById('statusText').textContent = 'Analyse DeepSeek & R√©daction...';
      log("Envoi au serveur...");

      google.script.run
        .withSuccessHandler(res => {
          document.getElementById('progressFill').style.width = '100%';
          btn.disabled = false;
          if (res.success) {
            document.getElementById('statusText').textContent = 'Succ√®s !';
            document.getElementById('docLink').href = res.url;
            document.getElementById('pdfLink').href = res.pdfUrl;
            document.getElementById('resultLinks').style.display = 'block';
            log(`Co√ªt: $${res.cost.totalUsd}`);
            log(`G√©n√©ration termin√©e.`);
          } else {
            document.getElementById('statusText').textContent = 'Erreur';
            log(`Erreur: ${res.error}`);
            alert(res.error);
          }
        })
        .withFailureHandler(err => {
          btn.disabled = false;
          log(`Crash: ${err}`);
          alert(err);
        })
        .generateFromForm(data);
    });
  </script>
</body>
</html>