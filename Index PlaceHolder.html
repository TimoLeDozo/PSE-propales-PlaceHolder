<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Console Neural ¬∑ MSI Propales B2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* --- VARIABLES & RESET --- */
    :root {
      --bg-deep: #050505;
      --glass-panel: rgba(255, 255, 255, 0.03);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-blur: 20px;
      
      --input-bg: rgba(0, 0, 0, 0.4);
      --input-border: rgba(255, 255, 255, 0.1);
      
      --accent-primary: #e0a3ff;
      --accent-secondary: #ff69b4;
      --accent-tertiary: #00ffff;
      
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.5);
      
      --card-radius: 24px;
      --input-radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-deep);
      color: var(--text-main);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.5;
    }

    /* --- BACKGROUND NEURAL (Tir√© du Template) --- */
    .neural-background {
      position: fixed; inset: 0; z-index: -3;
      background: radial-gradient(circle at 15% 85%, rgba(75, 0, 130, 0.4) 0%, transparent 50%),
                  radial-gradient(circle at 85% 15%, rgba(139, 37, 99, 0.4) 0%, transparent 50%),
                  linear-gradient(135deg, #050505 0%, #1a0b2e 100%);
    }
    
    /* Formes flottantes */
    .geometric-shapes { position: fixed; inset: 0; z-index: -2; pointer-events: none; }
    .shape { position: absolute; border: 1px solid rgba(0, 255, 255, 0.15); animation: float 20s infinite linear; }
    .shape:nth-child(1) { width: 150px; height: 150px; left: 10%; top: 20%; border-radius: 30px; border-color: rgba(224, 163, 255, 0.2); }
    .shape:nth-child(2) { width: 80px; height: 80px; right: 15%; top: 60%; border-radius: 50%; border-color: rgba(255, 105, 180, 0.2); animation-duration: 25s; }
    @keyframes float { 0% { transform: translateY(0) rotate(0deg); } 100% { transform: translateY(-100px) rotate(360deg); } }

    /* --- LAYOUT --- */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 40px 20px;
      display: grid;
      grid-template-columns: 1fr 380px; /* Layout EXACT des screenshots */
      gap: 30px;
    }

    /* --- HEADER --- */
    .header-section {
      grid-column: 1 / -1;
      text-align: center;
      margin-bottom: 60px;
      margin-top: 40px;
    }
    .logo-container {
      display: inline-block;
      background: rgba(255,255,255,0.95);
      padding: 10px 20px;
      border-radius: 16px;
      margin-bottom: 25px;
      box-shadow: 0 0 30px rgba(255,255,255,0.15);
    }
    .logo-container img { height: 45px; display: block; }
    
    h1 {
      font-size: 3.5rem;
      font-weight: 800;
      margin: 0 0 15px 0;
      background: linear-gradient(to right, #fff, #e0a3ff);
      -webkit-background-clip: text;
      color: transparent;
      letter-spacing: -1px;
    }
    .subtitle {
      font-size: 1rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto;
      font-weight: 300;
    }

    /* --- CARDS (Panneaux) --- */
    .card {
      background: var(--glass-panel);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(var(--glass-blur));
      border-radius: var(--card-radius);
      padding: 35px;
      margin-bottom: 30px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.4);
      position: relative;
      overflow: hidden;
    }
    
    /* Effet de lueur sur les cards */
    .card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
      font-size: 1.25rem;
      font-weight: 700;
      color: #fff;
    }
    .icon-emoji { font-size: 1.4rem; }

    /* --- FORM STYLES --- */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .form-group { display: flex; flex-direction: column; gap: 8px; }
    .full-width { grid-column: 1 / -1; }

    label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 700;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    input, textarea, select {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: var(--input-radius);
      padding: 16px;
      color: #fff;
      font-family: 'Inter', sans-serif;
      font-size: 0.95rem;
      transition: 0.3s ease;
      width: 100%;
    }
    textarea { resize: vertical; min-height: 120px; line-height: 1.6; }

    input:focus, textarea:focus {
      outline: none;
      border-color: rgba(224, 163, 255, 0.5);
      background: rgba(0,0,0,0.6);
      box-shadow: 0 0 0 4px rgba(224, 163, 255, 0.1);
    }

    /* Input placeholders styling to match screenshots */
    ::placeholder { color: rgba(255,255,255,0.25); }

    /* --- ACTION BUTTONS (Dicter) --- */
    .btn-dictate {
      background: rgba(0, 255, 255, 0.1);
      color: #00ffff;
      border: 1px solid rgba(0, 255, 255, 0.3);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.65rem;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-dictate:hover {
      background: rgba(0, 255, 255, 0.2);
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
    }
    .status-text { font-size: 0.65rem; color: rgba(255,255,255,0.3); }

    /* --- SIDEBAR (PILOTAGE) --- */
    .sidebar { position: sticky; top: 30px; }
    
    .pilotage-card {
      padding: 0; /* Header is distinct */
      background: rgba(15, 15, 20, 0.6);
      backdrop-filter: blur(30px);
    }
    
    .pilotage-header {
      background: #000000;
      padding: 25px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--card-radius) var(--card-radius) 0 0;
    }
    .pilotage-title {
      font-size: 0.9rem;
      font-weight: 800;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .pilotage-subtitle { font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; }

    .pilotage-body { padding: 25px; }

    .status-box {
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    .status-main { font-size: 1rem; font-weight: 600; color: #fff; display: block; margin-bottom: 8px; }
    .status-sub { font-size: 0.75rem; color: #00ff9d; font-family: monospace; }

    /* Bouton principal (G√©n√©rer) */
    .btn-main {
      width: 100%;
      background: linear-gradient(90deg, #e0a3ff, #ff69b4);
      border: none;
      padding: 16px;
      border-radius: 12px;
      color: #000;
      font-weight: 700;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(224, 163, 255, 0.3);
      transition: 0.3s;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }
    .btn-main:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 30px rgba(224, 163, 255, 0.5);
    }
    .btn-main:disabled { opacity: 0.6; cursor: not-allowed; }

    .btn-secondary {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      color: #00ffff;
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      font-weight: 600;
      margin-top: 15px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      text-decoration: none;
      transition: 0.3s;
    }
    .btn-secondary:hover { background: rgba(0, 255, 255, 0.2); }

    /* Logs & History */
    .history-list { margin-top: 30px; }
    .history-item {
      display: flex; gap: 15px; margin-bottom: 20px; position: relative;
    }
    .history-item::before {
      content: ''; position: absolute; left: 6px; top: 20px; bottom: -20px;
      width: 2px; background: rgba(255,255,255,0.1);
    }
    .history-item:last-child::before { display: none; }
    
    .history-dot {
      width: 14px; height: 14px; border-radius: 50%;
      background: #000; border: 2px solid #00ffff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
      flex-shrink: 0; margin-top: 4px;
    }
    .history-content { font-size: 0.85rem; color: rgba(255,255,255,0.8); }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed rgba(255,255,255,0.15);
      border-radius: 16px;
      padding: 20px;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: 0.3s;
    }
    .upload-zone:hover { border-color: #00ffff; background: rgba(0,255,255,0.05); }
    .upload-btn-fake {
      background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 8px;
      font-size: 0.8rem; font-weight: 600; color: #fff;
    }

    /* --- FOOTER MATRIX --- */
    .matrix-section {
      grid-column: 1 / -1;
      text-align: center;
      margin-top: 60px;
      padding-top: 60px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .matrix-title { font-size: 2rem; font-weight: 800; margin-bottom: 40px; }
    .matrix-grid {
      display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;
    }
    .matrix-card {
      width: 160px; height: 180px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 15px; transition: 0.3s;
    }
    .matrix-card:hover { transform: translateY(-10px); background: rgba(255,255,255,0.08); border-color: #e0a3ff; }
    .matrix-icon { font-size: 2rem; margin-bottom: 15px; }
    .matrix-label { font-weight: 700; font-size: 0.85rem; color: #fff; margin-bottom: 5px; }
    .matrix-sub { font-size: 0.7rem; color: var(--text-muted); line-height: 1.3; }

    /* Responsive */
    @media (max-width: 1000px) {
      .container { grid-template-columns: 1fr; }
      .sidebar { position: relative; top: 0; }
    }
  </style>
</head>
<body>

  <div class="neural-background"></div>
  <div class="geometric-shapes">
    <div class="shape"></div><div class="shape"></div>
  </div>

  <div class="container">
    
    <header class="header-section">
      <div class="logo-container">
        <img src="https://upload.wikimedia.org/wikipedia/fr/thumb/1/1d/Logo_ICAM_-_2008.svg/1200px-Logo_ICAM_-_2008.svg.png" alt="Icam">
      </div>
      <p style="font-size:0.8rem; font-weight:700; text-transform:uppercase; letter-spacing:2px; margin-bottom:10px; color:rgba(255,255,255,0.6);">G√©n√©rateur Propale V2 (Corrig√©)</p>
      <h1>Console Neural ¬∑ G√©n√©ration de propale</h1>
      <p class="subtitle">Renseignez les zones cl√©s. Toutes les informations sont transmises √† Apps Script qui orchestre la copie du template Google Docs, le remplissage des zones surlign√©es et l'appel √† DeepSeek.</p>
    </header>

    <main>
      
      <div class="card">
        <div class="card-header">
          <span class="icon-emoji">üìã</span> Informations projet
        </div>
        <div class="form-row">
          <div class="form-group full-width">
            <label>Titre *</label>
            <input type="text" id="f_titre" placeholder="Optimisation flux entrep√¥t" required>
          </div>
          <div class="form-group">
            <label>Code Projet</label>
            <input type="text" id="f_codeProjet" placeholder="144-16">
          </div>
          <div class="form-group">
            <label>Date D√©but</label>
            <input type="text" id="f_dateDebut" placeholder="Septembre 2025">
          </div>
          <div class="form-group">
            <label>Nb. √âquipes</label>
            <input type="number" id="f_nbEquipes" value="1">
          </div>
          <div class="form-group">
            <label>Dur√©e (Semaines)</label>
            <input type="number" id="f_dureeSemaines" value="24">
          </div>
          <div class="form-group full-width">
            <label>Dur√©e (Texte)</label>
            <input type="text" id="f_dureeProjet" placeholder="Ex: 6 mois">
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="icon-emoji">üè¢</span> Entreprise & Contact
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Entreprise *</label>
            <input type="text" id="f_entrepriseNom" placeholder="Velibor SA">
          </div>
          <div class="form-group">
            <label>Adresse</label>
            <input type="text" id="f_entrepriseAdresse" placeholder="49 bis rue Sedaine, 75011 Paris">
          </div>
          <div class="form-group">
            <label>Logo URL (Mapped #D9D9D9)</label>
            <input type="text" id="f_entrepriseLogo" placeholder="https://exemple.com/logo.png">
          </div>
          <div class="form-group">
            <label>Nom Contact</label>
            <input type="text" id="f_clientNom" placeholder="Jean Dupont">
          </div>
          <div class="form-group">
            <label>Fonction</label>
            <input type="text" id="f_clientFonction" placeholder="Directeur Technique">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="text" id="f_clientEmail" placeholder="jean@exemple.com">
          </div>
          <div class="form-group full-width">
            <label>
              Histoire & ADN (Contexte)
              <button class="btn-dictate" data-target="f_ia_histoire">üéôÔ∏è DICTER</button>
            </label>
            <textarea id="f_ia_histoire" rows="2" placeholder="Ex: PME familiale cr√©√©e en 1970, savoir-faire artisanal..."></textarea>
          </div>
          <div class="form-group full-width">
            <label>
              Lieux / G√©ographie
              <button class="btn-dictate" data-target="f_ia_lieux">üéôÔ∏è DICTER</button>
            </label>
            <input type="text" id="f_ia_lieux" placeholder="Ex: D√©m√©nagement de Brie-Comte-Robert √† Moissy">
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="icon-emoji">üß†</span> Brief pour DeepSeek
        </div>
        <div class="form-group full-width" style="margin-bottom:20px;">
          <label>
            Probl√®me Principal *
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn-dictate" data-target="f_ia_probleme">üéôÔ∏è DICTER</button>
              <span class="status-text" id="status-f_ia_probleme">PR√äT.</span>
            </div>
          </label>
          <textarea id="f_ia_probleme" placeholder="Retards de livraison, manque de tra√ßabilit√©..."></textarea>
        </div>

        <div class="form-group full-width" style="margin-bottom:20px;">
          <label>
            Solution Propos√©e
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn-dictate" data-target="f_ia_solution">üéôÔ∏è DICTER</button>
              <span class="status-text" id="status-f_ia_solution">PR√äT.</span>
            </div>
          </label>
          <textarea id="f_ia_solution" placeholder="5S, outil de tracking, formation √©quipes..."></textarea>
        </div>

        <div class="form-group full-width">
          <label>
            Objectifs Cl√©s
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn-dictate" data-target="f_ia_objectifs">üéôÔ∏è DICTER</button>
              <span class="status-text" id="status-f_ia_objectifs">PR√äT.</span>
            </div>
          </label>
          <textarea id="f_ia_objectifs" rows="2" placeholder="R√©duire de 20% les temps de pr√©paration, etc."></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="icon-emoji">ü§ñ</span> Sections g√©n√©r√©es par DeepSeek
        </div>
        <div class="form-group full-width" style="margin-bottom:20px;">
          <label>Contexte <span class="status-text">G√âN√âR√â / √âDITION MANUELLE POSSIBLE</span></label>
          <textarea id="f_contexte" rows="3" readonly></textarea>
        </div>
        <div class="form-group full-width" style="margin-bottom:20px;">
          <label>D√©marche</label>
          <textarea id="f_demarche" rows="3" readonly></textarea>
        </div>
        <div class="form-group full-width" style="margin-bottom:20px;">
          <label>Phases</label>
          <textarea id="f_phases" rows="3" readonly></textarea>
        </div>
        <div class="form-group full-width">
          <label>Phrase de Cl√¥ture</label>
          <textarea id="f_phrase" rows="2" readonly></textarea>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="icon-emoji">üìé</span> Pi√®ces jointes & outils
        </div>
        <div class="form-group full-width">
          <label>Ajouter des documents (Jusqu'√† 15)</label>
          <div class="upload-zone" onclick="document.getElementById('f_attachments').click()">
            <div style="display:flex; align-items:center; gap:15px;">
              <button class="upload-btn-fake">S√©lect. fichiers</button>
              <span style="font-size:0.85rem; color:#fff;" id="fileLabel">Aucun fichier choisi</span>
            </div>
            <span style="font-size:0.75rem; color:rgba(255,255,255,0.4);">Aucun fichier s√©lectionn√© (0/15).</span>
            <input type="file" id="f_attachments" multiple style="display:none">
          </div>
        </div>
      </div>

    </main>

    <aside class="sidebar">
      <div class="card pilotage-card">
        <div class="pilotage-header">
          <div class="pilotage-title">
            <span>üìü</span> PILOTAGE & JOURNALISATION
          </div>
          <div class="pilotage-subtitle">
            Suivez l'√©tat de la g√©n√©ration, le suivi des co√ªts et les derniers √©v√®nements.
          </div>
        </div>

        <div class="pilotage-body">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span style="font-size:0.7rem; color:rgba(255,255,255,0.5); letter-spacing:1px;">STATUT EN DIRECT</span>
            <span style="font-size:0.6rem; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">CONSOLE IA</span>
          </div>

          <div class="status-box">
            <span class="status-main" id="statusMain">Pr√™t pour une nouvelle g√©n√©ration.</span>
          </div>

          <span class="status-sub" id="tokenEstimate">Estimation prompt ‚âà 0 tokens (limite 100000)</span>

          <div style="margin-top:30px; margin-bottom:10px;">
            <span style="font-size:0.7rem; color:rgba(255,255,255,0.5); letter-spacing:1px;">PR√âVISUALISATION</span>
          </div>
          
          <a href="#" class="btn-secondary" id="costLogBtn">
            <span>üìä</span> Journal des co√ªts
          </a>

          <div style="margin-top:10px; background:rgba(0,0,0,0.3); padding:15px; border-radius:12px; font-family:'Courier New'; font-size:0.75rem; color:#aaa; min-height:60px;">
            <span id="previewText">Pr√™t √† compiler les informations du brief.</span>
          </div>

          <button id="btnGenerate" class="btn-main" style="margin-top:30px;">
            <span>‚ú®</span> G√©n√©rer la propale
          </button>

          <div style="margin-top:30px;">
            <span style="font-size:0.7rem; color:rgba(255,255,255,0.5); letter-spacing:1px;">HISTORIQUE DES ACTIONS</span>
            <div class="history-list" id="historyList">
              <div class="history-item">
                <div class="history-dot"></div>
                <div class="history-content">Historique vide pour le moment.</div>
              </div>
            </div>
          </div>

          <div id="resultLinks" style="display:none; margin-top:20px;">
            <a href="#" id="docLink" target="_blank" class="btn-secondary" style="background:#00ffff; color:#000;">üìÑ Ouvrir Document</a>
            <a href="#" id="pdfLink" target="_blank" class="btn-secondary">‚¨áÔ∏è PDF</a>
          </div>

        </div>
      </div>
    </aside>

    <div class="matrix-section">
      <h2 class="matrix-title">Matrix Protocols</h2>
      <div class="matrix-grid">
        <div class="matrix-card">
          <div class="matrix-icon">üîÆ</div>
          <div class="matrix-label">Holographic UI</div>
          <div class="matrix-sub">Interface monofichier pr√™te pour Apps Script</div>
        </div>
        <div class="matrix-card">
          <div class="matrix-icon">üõ°Ô∏è</div>
          <div class="matrix-label">Quantum Security</div>
          <div class="matrix-sub">Cl√© DeepSeek stock√©e c√¥t√© serveur</div>
        </div>
        <div class="matrix-card">
          <div class="matrix-icon">üöÄ</div>
          <div class="matrix-label">Speed Navigation</div>
          <div class="matrix-sub">Acc√®s direct au document g√©n√©r√©</div>
        </div>
        <div class="matrix-card">
          <div class="matrix-icon">üíé</div>
          <div class="matrix-label">Crystal Storage</div>
          <div class="matrix-sub">Copie organis√©e dans Drive cible</div>
        </div>
        <div class="matrix-card">
          <div class="matrix-icon">üéØ</div>
          <div class="matrix-label">Neural Targeting</div>
          <div class="matrix-sub">Color mapping intelligent</div>
        </div>
        <div class="matrix-card">
          <div class="matrix-icon">‚≠ê</div>
          <div class="matrix-label">Stellar Network</div>
          <div class="matrix-sub">Workflow collaboratif Icam</div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- JS LOGIC (SIMILAR TO V1) ---
    
    // 1. Gestion Fichiers
    const fileInput = document.getElementById('f_attachments');
    let selectedFiles = [];
    fileInput.addEventListener('change', (e) => {
      selectedFiles = Array.from(e.target.files);
      document.getElementById('fileLabel').textContent = `${selectedFiles.length} fichier(s) choisi(s)`;
      addToHistory(`${selectedFiles.length} fichiers ajout√©s.`);
    });

    const readFile = (file) => new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = () => resolve({ name: file.name, mimeType: file.type, bytes: reader.result.split(',')[1] });
      reader.readAsDataURL(file);
    });

    // 2. Estimation Tokens
    document.body.addEventListener('input', () => {
      let chars = 0;
      ['f_titre', 'f_ia_histoire', 'f_ia_probleme', 'f_ia_solution'].forEach(id => {
        const val = document.getElementById(id).value;
        if(val) chars += val.length;
      });
      document.getElementById('tokenEstimate').textContent = `Estimation prompt ‚âà ${Math.ceil(chars/4)} tokens (limite 100000)`;
    });

    // 3. Bouton G√©n√©rer
    document.getElementById('btnGenerate').addEventListener('click', async () => {
      const btn = document.getElementById('btnGenerate');
      const statusMain = document.getElementById('statusMain');
      const previewText = document.getElementById('previewText');
      const resultLinks = document.getElementById('resultLinks');

      const titre = document.getElementById('f_titre').value;
      const entreprise = document.getElementById('f_entrepriseNom').value;

      if (!titre || !entreprise) {
        alert("Erreur: Champs Titre et Entreprise obligatoires.");
        return;
      }

      // UI Start
      btn.disabled = true;
      btn.innerHTML = "‚è≥ G√âN√âRATION EN COURS...";
      statusMain.textContent = "Initialisation...";
      previewText.textContent = "Pr√©paration des donn√©es...";
      resultLinks.style.display = 'none';
      addToHistory("D√©marrage s√©quence...");

      // Collecte Data (V2 PlaceHolder Logic)
      const data = {
        titre: titre,
        entrepriseNom: entreprise,
        codeProjet: document.getElementById('f_codeProjet').value,
        dateDebut: document.getElementById('f_dateDebut').value,
        dureeProjet: document.getElementById('f_dureeProjet').value,
        nbEquipes: document.getElementById('f_nbEquipes').value,
        dureeSemaines: document.getElementById('f_dureeSemaines').value,
        entrepriseLogo: document.getElementById('f_entrepriseLogo').value,
        entrepriseAdresse: document.getElementById('f_entrepriseAdresse').value,
        clientNom: document.getElementById('f_clientNom').value,
        clientFonction: document.getElementById('f_clientFonction').value,
        clientEmail: document.getElementById('f_clientEmail').value,
        // Specific V2
        ia_histoire: document.getElementById('f_ia_histoire').value,
        ia_lieux: document.getElementById('f_ia_lieux').value,
        ia_probleme: document.getElementById('f_ia_probleme').value,
        ia_solution: document.getElementById('f_ia_solution').value,
        ia_objectifs: document.getElementById('f_ia_objectifs').value
      };

      // Files
      if (selectedFiles.length > 0) {
        statusMain.textContent = "Lecture Fichiers...";
        try {
          data.attachments = await Promise.all(selectedFiles.map(readFile));
        } catch (e) {
          btn.disabled = false;
          alert("Erreur fichier");
          return;
        }
      }

      statusMain.textContent = "Appel DeepSeek (Raisonnement)...";
      
      // Server Call
      google.script.run
        .withSuccessHandler(res => {
          btn.disabled = false;
          btn.innerHTML = "‚ú® G√âN√âRER LA PROPALE";

          if (res.success) {
            statusMain.textContent = "Succ√®s !";
            previewText.textContent = "Document g√©n√©r√©. Co√ªt: $" + (res.cost?.totalUsd?.toFixed(4) || "0");
            addToHistory("G√©n√©ration termin√©e.");
            
            // Preview fill
            if(res.aiSections) {
              document.getElementById('f_contexte').value = res.aiSections.contexte || "";
              document.getElementById('f_demarche').value = res.aiSections.demarche || "";
              document.getElementById('f_phases').value = res.aiSections.phases || "";
              document.getElementById('f_phrase').value = res.aiSections.phrase || "";
            }

            document.getElementById('docLink').href = res.url;
            document.getElementById('pdfLink').href = res.pdfUrl;
            resultLinks.style.display = 'grid';
          } else {
            statusMain.textContent = "Erreur";
            alert(res.error);
          }
        })
        .withFailureHandler(err => {
          btn.disabled = false;
          statusMain.textContent = "Crash";
          alert(err);
        })
        .generateFromForm(data);
    });

    function addToHistory(msg) {
      const list = document.getElementById('historyList');
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `<div class="history-dot"></div><div class="history-content">${msg}</div>`;
      list.prepend(item);
    }

    // Dictation (Simplified)
    document.querySelectorAll('.btn-dictate').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetId = btn.dataset.target;
        const target = document.getElementById(targetId);
        const status = document.getElementById('status-'+targetId);
        
        if (!window.webkitSpeechRecognition) { alert("Navigateur non compatible"); return; }
        
        const rec = new webkitSpeechRecognition();
        rec.lang = "fr-FR";
        rec.start();
        
        if(status) status.textContent = "√âCOUTE...";
        
        rec.onresult = (e) => {
          const txt = e.results[0][0].transcript;
          target.value += (target.value ? " " : "") + txt;
          if(status) status.textContent = "OK";
        };
      });
    });
  </script>
</body>
</html>
